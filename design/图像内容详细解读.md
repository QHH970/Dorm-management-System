# 宿舍管理系统 — UML 图像详细解读

## 1. 类图 (`class_diagram.png`)

**图像结构**：该图显示系统的核心架构分为三层。

### 边界层（Boundary - Controller）
- **StudentController** / DormRoomController / RepairController 等：这些是 REST 接口控制器，接收前端 HTTP 请求。
- 职责：解析请求参数、调用 Service 方法、格式化响应。
- 对外部（前端）提供统一的 REST 端点。

### 控制层（Control - Service）
- **StudentService** / DormRoomService / RepairService 等：业务逻辑处理层。
- 职责：验证数据、执行业务规则、协调多个 Mapper 操作、返回结果给 Controller。
- 示例：`StudentService.stuLogin()` 负责从 Mapper 查询学生，验证密码逻辑。

### 实体层（Entity - Domain Model）
- **Student** / DormRoom / Repair / AdjustRoom / Notice / Visitor 等：数据库表对应的 POJO 类。
- 字段示例：
  - Student：username(PK), password, name, age, gender, phoneNum, email, avatar
  - DormRoom：dormRoomId(PK), dormBuildId, floorNum, maxCapacity, currentCapacity, firstBed/secondBed/thirdBed/fourthBed
  - AdjustRoom：id, username, currentRoomId, towardsRoomId, state, applyTime, finishTime

### 关键关系
- **Controller → Service**：单向依赖（Controller 调用 Service）
- **Service → Entity**：单向依赖（Service 操作/返回 Entity 对象）
- **Entity 间关系**：
  - Student "1" -- "0..4" DormRoom：一个学生最多占用 4 张床中的 1 张
  - Repair "*" → Student：多条报修记录关联到一个学生
  - AdjustRoom "*" → Student：多条调宿申请关联到一个学生
  - Notice "*" → Admin：公告由管理员发布
  - Visitor "*" → DormRoom：多条访客记录关联到一个房间

**总体设计模式**：标准 MVC 三层架构 + MyBatis-Plus ORM（Mapper 层自动生成）。

---

## 2. 用例图 (`use_case_diagram.png`)

**图像结构**：显示系统的参与者（角色）与其能执行的用例（功能）。

### 参与者（Actors）
- **Student**（学生）：蓝色圆圈小人图标
- **DormManager**（宿舍管理员）：蓝色圆圈小人图标
- **Admin**（系统管理员）：蓝色圆圈小人图标
- **System**（系统自动任务）：可选，用于定时任务

### 用例（Use Cases）— 椭圆框
按参与者分类：

**学生能做的**
- **UC_Login**：登录系统
- **UC_ViewMyRoom**：查看我的宿舍（床位信息）
- **UC_ApplyAdjust**：申请调宿/换宿
- **UC_SubmitRepair**：提交报修
- **UC_ViewNotice**：查看公告
- **UC_RegisterVisitor**：访客登记

**宿管能做的**
- **UC_Login**：登录系统
- **UC_ApproveAdjust**：审批调宿申请
- **UC_ViewNotice**：查看/通知公告
- **UC_ManageStudents**：管理学生信息

**管理员能做的**
- **UC_Login**：登录系统
- **UC_ManageNotice**：发布/编辑/删除公告
- **UC_ManageStudents**：学生管理（CRUD）

### 关系与流程理解
- 学生 → UC_Login：先登录才能进行其他操作
- 学生 → UC_ApplyAdjust → (需宿管审批) UC_ApproveAdjust
- 系统 → UC_ViewNotice：系统自动推送首页公告（定时任务）

**图的意义**：快速了解每个角色的权限与功能范围，帮助需求分析与测试用例设计。

---

## 3. 时序图 (`sequence_diagrams.png`)

**图像结构**：展示关键用例的逐步执行流程（消息序列）。该图包含 4 个分段的时序流程。

### 段 1：登录 (UC_Login)

参与者顺序（从左到右）：
- **Student**（学生）
- **StudentController**（前端请求接收）
- **StudentService**（业务逻辑）
- **StudentMapper/DB**（数据库操作）

时序步骤：
1. Student 提交 `POST /stu/login {username, password}`
2. StudentController 接收，调用 `StudentService.stuLogin(username, password)`
3. StudentService 调用 StudentMapper 执行 `SELECT * FROM student WHERE username=? AND password=?`
4. StudentMapper 向数据库发送 SQL，返回查询结果
5. StudentService 返回 Student 对象（或 null 如验证失败）
6. StudentController 判断结果：
   - **成功**：将 User 对象和 Identity="stu" 存入 HttpSession，返回 `{code: 0, data: user}`
   - **失败**：返回 `{code: -1, msg: "用户名或密码错误"}`
7. Student 获得响应，登录完成

**关键点**：Session 状态维护，会话管理。

---

### 段 2：申请调宿 (UC_ApplyAdjust)

参与者：Student → AdjustRoomController → AdjustRoomService → AdjustRoomMapper/DB

时序步骤：
1. Student 提交调宿申请表单 `POST /adjustRoom/add {AdjustRoom}` 
   - 包含：username, currentRoomId, currentBedId, towardsRoomId, towardsBedId, applyTime
2. AdjustRoomController 接收，调用 `AdjustRoomService.addApply(adjustRoom)`
3. AdjustRoomService 调用 Mapper 执行 `INSERT INTO adjust_room (...)`
4. 数据库确认插入成功
5. 返回成功响应给前端

**关键点**：申请记录保存，状态初始化为"待审批"。

---

### 段 3：宿管审批调宿 (UC_ApproveAdjust)

参与者：DormManager → AdjustRoomController → DormRoomService / AdjustRoomService → DB

时序步骤：
1. DormManager（宿管） PUT `/adjustRoom/update/{state=true}` 批准申请
2. AdjustRoomController 接收，判断 `state` 值
   - **如果 state=true（批准）**：
     - 调用 `DormRoomService.adjustRoomUpdate(adjustRoom)` 更新床位
       - 从原宿舍的 bed 字段清除该学生
       - 在目标宿舍的 bed 字段添加该学生
       - 更新 currentCapacity（容量）
     - 然后调用 `AdjustRoomService.updateApply(adjustRoom)` 更新申请表
       - 设置 state="已完成"，finishTime=当前时间
   - **如果 state=false（拒绝）**：仅更新 adjust_room 状态，不修改 dorm_room
3. 返回操作结果

**关键点**：**原子性操作**（床位更新与申请状态必须同时成功或同时失败，避免数据不一致）。

---

### 段 4：提交报修 (UC_SubmitRepair)

参与者：Student → RepairController → RepairService → RepairMapper/DB

时序步骤：
1. Student 提交报修单 `POST /repair/add {Repair}`
   - 包含：title, content, dormBuildId, dormRoomId, repairer, orderBuildTime
2. RepairController 接收，调用 `RepairService.addNewOrder(repair)`
3. RepairService 调用 Mapper 执行 `INSERT INTO repair (...)`
4. 数据库确认，返回插入成功
5. RepairController 返回响应

**后续流程**：宿管或维修人员更新 state 和 orderFinishTime。

**图的意义**：明确系统如何处理每个用例，开发人员可按此设计代码实现。

---

## 4. 协作图（修复版）(`collaboration_diagrams.png`)

**图像结构**：与时序图类似，但采用**参与者-消息编号**的方式展示交互，分为三个用例阶段。

### 用例 1：学生登录

参与者：S1(Student) → SC1(StudentController) → SS1(StudentService) → SM1(StudentMapper) → DB1(Student DB)

消息编号与流向：
```
1. S1 --login(user,pass)--> SC1
2. SC1 --stuLogin(user,pass)--> SS1
3. SS1 --query Student--> SM1
4. SM1 --SELECT--> DB1
5. DB1 --result--> SM1
6. SM1 --Student obj--> SS1
7. SS1 --Student obj--> SC1
8. SC1 --setSession--> S1
```

**关键点**：逐步返回，S1 收到来自 SC1 的 setSession 消息表示登录完成。

---

### 用例 2：申请调宿

参与者：S2(Student) → ARC(AdjustRoomController) → ARS(AdjustRoomService) → ARM(AdjustRoomMapper) → AdjDB

消息编号：
```
1. S2 --addApply(AdjustRoom)--> ARC
2. ARC --addApply(adjust)--> ARS
3. ARS --insert record--> ARM
4. ARM --INSERT--> AdjDB
5. AdjDB --OK--> ARM
6. ARM --OK--> ARS
7. ARS --OK--> ARC
8. ARC --response--> S2
```

**关键点**：消息链式传递与返回，每层成功才继续下一步。

---

### 用例 3：宿管审批

参与者：DM(DormManager) → ARC2(AdjustRoomController) → DRS(DormRoomService) / ARM → DB

消息编号：
```
1. DM --approve(state=true)--> ARC2
2. ARC2 --adjustRoomUpdate(adjust)--> DRS
3. DRS --update bed fields--> DRM
4. DRM --UPDATE--> DormDB
5. DormDB --OK--> DRM
6. DRM --OK--> DRS
7. DRS --OK--> ARC2
8. ARC2 --updateApply(adjust)--> ARS
9. ARS --update record--> ARM
10. ARM --UPDATE--> AdjustRoomDB
11. AdjustRoomDB --OK--> ARM
12. ARM --OK--> ARS
13. ARS --OK--> ARC2
14. ARC2 --response--> DM
```

**关键点**：两阶段操作（先更新宿舍信息，再更新申请状态），消息编号帮助追踪关键操作顺序。

**图的意义**：协作图强调**参与者间的交互关系**与**消息序列**，是理解系统如何通过对象间消息传递完成用例的关键。

---

## 5. 协作图简化版 (`collaboration_diagrams_short.png`)

**图像结构**：相比修复版更简洁，仅展示两个关键用例。

### 用例：申请与审批

参与者：Student → DormManager、StudentController → AdjustRoomService → DormRoomService → DB(s)

消息流：
- 学生提交申请 → Controller → Service 存入 adjust_room 表
- 宿管审批批准 → Controller → DormRoomService 更新床位 → AdjustRoomService 更新申请状态

**简化点**：省略了 Mapper 层细节，直接展示 Service 到 DB 的操作。

**用途**：快速、高层次地理解申请-审批流程。

---

## 6. 协作图更简化版 (`collaboration_diagrams_short2.png`)

**图像结构**：最简化版本，采用**标准时序图语法**（participant 元素），分为三个阶段。

### 三大主要交互
1. **学生提交调宿申请**：Student → Controller → Service → DB（insert）
2. **系统确认**：DB 返回 OK，消息链返回
3. **宿管审批流程**：DormManager → Controller → DormRoomService（更新房间） → Service（更新申请状态）

**特点**：
- 使用分隔线（`==`）清晰划分阶段
- 参与者垂直排列，消息水平箭头表示交互方向
- 最易理解的格式

**用途**：向非技术人员解释系统工作流程。

---

## 图像关系与使用场景总结

| 图像 | 类型 | 用途 | 适用场景 |
|------|------|------|---------|
| 类图 | 静态结构 | 展示系统组件与关系 | 代码实现、架构设计审查 |
| 用例图 | 需求分析 | 明确参与者与功能范围 | 需求澄清、测试用例设计、权限管理 |
| 时序图 | 动态交互 | 详细步骤与顺序 | 代码流程理解、调试、文档 |
| 协作图（修复版） | 动态交互 | 参与者关系与消息编号 | 复杂交互分析、团队沟通 |
| 协作图（简化版） | 动态交互 | 核心流程概览 | 快速理解、培训 |
| 协作图（更简化版） | 动态交互 | 最高层抽象 | 非技术人员演讲、需求评审 |

---

## 核心业务流程总结

### 核心用例链路
1. **用户登录** → session 建立 → 获取身份与用户信息
2. **学生查看宿舍** → 查询 dorm_room 中该学生的床位 → 展示房间号、床位号、同舍人信息
3. **申请调宿** → 提交 AdjustRoom 申请 → 宿管批准 → 更新 dorm_room 床位 → 完成调宿
4. **报修与公告** → 独立模块，提交→存储→查询→管理

### 关键业务规则
- **床位表示**：dorm_room 表的 firstBed/secondBed/thirdBed/fourthBed 字段存储学生 username（空表示未占用）
- **容量管理**：currentCapacity 记录实时入住人数，不超过 maxCapacity
- **调宿原子性**：从原房间删除学生，在新房间添加学生，申请状态同时更新
- **身份权限**：Identity（stu/manager/admin）控制功能可访问性
- **会话维护**：HttpSession 存储 User 对象和 Identity，用于后续请求的身份确认

---

**结论**：这套 6 张图系统地从**静态架构**（类图）→ **功能范围**（用例图）→ **动态流程**（时序/协作图）展示了宿舍管理系统的完整设计，帮助开发、测试、产品等多方角色理解系统。
