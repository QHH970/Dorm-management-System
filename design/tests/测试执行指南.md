# 测试用例执行指南及示例代码

## 目录
1. [环境准备](#环境准备)
2. [执行各类型测试用例](#执行各类型测试用例)
3. [完整的单元测试代码](#完整的单元测试代码)
4. [完整的集成测试代码](#完整的集成测试代码)
5. [异常测试代码详解](#异常测试代码详解)
6. [测试结果验证](#测试结果验证)

---

## 环境准备

### 1. 项目配置验证

#### pom.xml 中的测试依赖检查
```xml
<!-- 已存在的测试依赖 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <scope>test</scope>
</dependency>
```

#### JUnit 5 和 Mockito 自动包含
Spring Boot Starter Test 包含：
- JUnit 5 (Jupiter)
- Mockito
- AssertJ
- Spring Test

### 2. 执行前检查

```bash
# 检查Java版本（需要8+）
java -version

# 检查Maven版本（需要3.6+）
mvn -version

# 检查测试源文件是否存在
ls springboot/src/test/java/com/example/springboot/
```

---

## 执行各类型测试用例

### 1. 黑盒测试执行

#### 1.1 执行调宿模块所有黑盒测试

```bash
# 执行AdjustRoomServiceImplTest中的所有测试
mvn -Dtest=AdjustRoomServiceImplTest test

# 执行单个测试方法
mvn -Dtest=AdjustRoomServiceImplTest#addApply_success test
mvn -Dtest=AdjustRoomServiceImplTest#find_returnsPage test
mvn -Dtest=AdjustRoomServiceImplTest#deleteAdjustment_nonExisting_returnsZero test
mvn -Dtest=AdjustRoomServiceImplTest#updateApply_success test
```

#### 1.2 执行报修模块所有黑盒测试

```bash
# 执行RepairServiceImplTest中的所有测试
mvn -Dtest=RepairServiceImplTest test

# 执行单个方法
mvn -Dtest=RepairServiceImplTest#addNewOrder_success test
mvn -Dtest=RepairServiceImplTest#deleteOrder_notFound_returnsZero test
```

#### 1.3 执行输出示例

```
[INFO] Running com.example.springboot.service.impl.AdjustRoomServiceImplTest
[INFO] Tests run: 5, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.456 s
[INFO] ✓ addApply_success
[INFO] ✓ find_returnsPage
[INFO] ✓ deleteAdjustment_nonExisting_returnsZero
[INFO] ✓ updateApply_success
[INFO] ✓ addApply_mapperThrows_exceptionPropagated
[INFO] BUILD SUCCESS
```

---

### 2. 白盒测试执行

白盒测试通过分析代码中的所有分支执行，验证覆盖率。

#### 2.1 使用JaCoCo生成覆盖率报告

```bash
# 安装JaCoCo插件并生成覆盖率报告
mvn clean test jacoco:report

# 查看覆盖率HTML报告
# 文件位于: target/site/jacoco/index.html
```

#### 2.2 覆盖率报告分析

在 `target/site/jacoco/` 中：
- `index.html` - 总体覆盖率统计
- `com.example.springboot.service.impl/AdjustRoomServiceImpl.html` - 详细覆盖率
- 红色部分：未被测试的代码
- 黄色部分：部分被测试的分支
- 绿色部分：完全被测试的代码

---

### 3. 异常测试执行

#### 3.1 执行单个异常测试

```bash
# 执行Mapper异常测试
mvn -Dtest=AdjustRoomServiceImplTest#addApply_mapperThrows_exceptionPropagated test

# 执行非法参数测试（需要补充编写）
mvn -Dtest=AdjustRoomServiceImplTest#find_negativePageNum_exceptionOrEmpty test
```

#### 3.2 验证异常是否被正确捕获

```bash
# 运行测试并查看是否有异常信息
mvn -e test -Dtest=AdjustRoomServiceImplTest#addApply_mapperThrows_exceptionPropagated

# -e 选项显示详细的异常堆栈跟踪
```

---

### 4. 集成测试执行

#### 4.1 执行集成测试

```bash
# 执行调宿集成测试（如果存在）
mvn -Dtest=AdjustRoomServiceIntegrationTest test

# 执行所有集成测试
mvn -Dtest=**/*IntegrationTest test
```

#### 4.2 集成测试特点

- 启动完整的Spring Boot应用上下文（较慢，5-10秒）
- 验证Spring Bean注入
- 验证@Transactional事务管理

---

### 5. 执行所有测试

```bash
# 执行项目中的所有测试
mvn clean test

# 执行所有测试并生成报告
mvn clean test surefire-report:report

# 仅执行单元测试（排除集成测试）
mvn -Dtest=!**/*IntegrationTest test
```

---

## 完整的单元测试代码

### 调宿服务单元测试 - 完整版

**文件路径:** `springboot/src/test/java/com/example/springboot/service/impl/AdjustRoomServiceImplTest.java`

```java
package com.example.springboot.service.impl;

import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.example.springboot.entity.AdjustRoom;
import com.example.springboot.mapper.AdjustRoomMapper;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

/**
 * AdjustRoomServiceImpl 单元测试
 * 
 * 测试方法：
 * 1. 使用Mockito Mock AdjustRoomMapper避免真实数据库操作
 * 2. 验证Service正确调用Mapper
 * 3. 验证返回值和异常处理
 */
@DisplayName("调宿服务单元测试")
class AdjustRoomServiceImplTest {

    // Mapper的Mock桶 - 模拟数据库访问
    @Mock
    private AdjustRoomMapper adjustRoomMapper;

    // 被测试的Service - @InjectMocks自动注入Mock依赖
    @InjectMocks
    private AdjustRoomServiceImpl adjustRoomService;

    /**
     * 测试初始化
     * 在每个测试方法前执行，初始化Mock对象
     */
    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
    }

    // ============ 黑盒测试用例 ============

    /**
     * TC-AR-001: 添加调宿申请 - 成功情况
     * 
     * 预期行为：当Mapper返回1时，Service也返回1
     * 验证内容：
     * 1. 返回值是否为1
     * 2. Mapper是否被调用了一次
     * 3. 调用参数是否正确
     */
    @Test
    @DisplayName("添加调宿申请 - 成功")
    void addApply_success() {
        // 1. 构造测试数据 - 创建调宿申请对象
        AdjustRoom adj = new AdjustRoom();
        adj.setUsername("stu1");
        adj.setName("张三");
        adj.setCurrentRoomId(101);
        adj.setCurrentBedId(1);
        adj.setTowardsRoomId(201);
        adj.setTowardsBedId(2);
        adj.setState("待审批");
        adj.setApplyTime("2025-11-25");

        // 2. 设置Mapper桩行为
        // when().thenReturn() 表示：当调用insert时，返回1
        when(adjustRoomMapper.insert(any(AdjustRoom.class))).thenReturn(1);

        // 3. 执行被测试的方法
        int res = adjustRoomService.addApply(adj);

        // 4. 验证结果
        assertEquals(1, res, "添加成功应返回1");
        
        // 5. 验证Mapper被正确调用
        verify(adjustRoomMapper, times(1)).insert(adj);
    }

    /**
     * TC-AR-002: 查询调宿申请 - 分页查询
     * 
     * 预期行为：返回分页结果
     * 验证内容：
     * 1. 返回的Page对象不为null
     * 2. 分页参数是否正确传递
     */
    @Test
    @DisplayName("查询调宿申请 - 分页结果")
    void find_returnsPage() {
        // 1. 构造模拟的返回值
        Page<AdjustRoom> mockPage = new Page<>(1, 10);
        mockPage.setTotal(3);  // 模拟总记录数
        
        // 2. 设置Mapper桩行为 - 查询调宿申请
        when(adjustRoomMapper.selectPage(any(Page.class), any()))
            .thenReturn(mockPage);

        // 3. 执行查询
        Page<?> result = adjustRoomService.find(1, 10, "stu");

        // 4. 验证结果
        assertNotNull(result, "查询结果不应为null");
        assertEquals(1, result.getCurrent(), "当前页应为1");
        assertEquals(10, result.getSize(), "每页大小应为10");
        assertEquals(3, result.getTotal(), "总记录数应为3");
        
        // 5. 验证Mapper被调用一次
        verify(adjustRoomMapper, times(1))
            .selectPage(any(Page.class), any());
    }

    /**
     * TC-AR-003: 删除调宿申请 - 成功删除
     * 
     * 预期行为：删除存在的记录返回1
     */
    @Test
    @DisplayName("删除调宿申请 - 记录存在")
    void deleteAdjustment_success() {
        // 设置Mapper返回1表示删除成功
        when(adjustRoomMapper.deleteById(1)).thenReturn(1);
        
        // 执行删除
        int res = adjustRoomService.deleteAdjustment(1);
        
        // 验证结果
        assertEquals(1, res, "删除成功应返回1");
        verify(adjustRoomMapper, times(1)).deleteById(1);
    }

    /**
     * TC-AR-004: 删除调宿申请 - 记录不存在
     * 
     * 预期行为：删除不存在的记录返回0（边界条件测试）
     * 这是等价类和边界值分析的典型例子
     */
    @Test
    @DisplayName("删除调宿申请 - 记录不存在")
    void deleteAdjustment_nonExisting_returnsZero() {
        // 模拟删除不存在的ID
        when(adjustRoomMapper.deleteById(999)).thenReturn(0);
        
        int res = adjustRoomService.deleteAdjustment(999);
        
        // 删除不存在的记录应返回0
        assertEquals(0, res, "删除不存在的记录应返回0");
        verify(adjustRoomMapper, times(1)).deleteById(999);
    }

    /**
     * TC-AR-005: 更新调宿申请
     * 
     * 预期行为：成功更新返回1
     */
    @Test
    @DisplayName("更新调宿申请 - 状态更新")
    void updateApply_success() {
        // 构造更新后的对象
        AdjustRoom adj = new AdjustRoom();
        adj.setId(1);
        adj.setState("已通过");
        adj.setFinishTime("2025-11-25");
        
        // 设置Mapper返回1表示更新成功
        when(adjustRoomMapper.updateById(adj)).thenReturn(1);
        
        int res = adjustRoomService.updateApply(adj);
        
        assertEquals(1, res, "更新成功应返回1");
        verify(adjustRoomMapper, times(1)).updateById(adj);
    }

    /**
     * TC-AR-006: 更新调宿申请 - 记录不存在
     * 
     * 预期行为：更新不存在的记录返回0
     */
    @Test
    @DisplayName("更新调宿申请 - 记录不存在")
    void updateApply_notFound_returnsZero() {
        AdjustRoom adj = new AdjustRoom();
        adj.setId(999);
        adj.setState("已通过");
        
        // Mapper返回0表示没有更新任何行
        when(adjustRoomMapper.updateById(adj)).thenReturn(0);
        
        int res = adjustRoomService.updateApply(adj);
        
        assertEquals(0, res, "更新不存在的记录应返回0");
    }

    // ============ 异常测试用例 ============

    /**
     * TC-EX-AR-001: Mapper异常 - 数据库连接失败
     * 
     * 预期行为：Service应该将异常向上传播（不吞掉异常）
     * 测试点：异常处理和事务回滚
     */
    @Test
    @DisplayName("异常测试 - Mapper抛异常")
    void addApply_mapperThrows_exceptionPropagated() {
        AdjustRoom adj = new AdjustRoom();
        adj.setUsername("stu1");
        
        // 设置Mapper抛出异常
        when(adjustRoomMapper.insert(any(AdjustRoom.class)))
            .thenThrow(new RuntimeException("数据库连接失败"));

        // 验证异常被正确抛出
        RuntimeException ex = assertThrows(RuntimeException.class, () -> {
            adjustRoomService.addApply(adj);
        });
        
        // 验证异常信息
        assertTrue(ex.getMessage().contains("数据库连接失败"),
            "异常信息应包含'数据库连接失败'");
        
        // 验证Mapper确实被调用过
        verify(adjustRoomMapper, times(1)).insert(adj);
    }

    /**
     * TC-EX-AR-002: Mapper异常 - SQL错误
     * 
     * 预期行为：传播异常并触发事务回滚
     */
    @Test
    @DisplayName("异常测试 - SQL执行错误")
    void deleteAdjustment_mapperThrows_sqlError() {
        when(adjustRoomMapper.deleteById(any()))
            .thenThrow(new RuntimeException("SQL执行错误"));

        assertThrows(RuntimeException.class, () -> {
            adjustRoomService.deleteAdjustment(1);
        });
        
        verify(adjustRoomMapper, times(1)).deleteById(1);
    }

    // ============ 白盒测试用例 - 分支覆盖 ============

    /**
     * TC-WB-AR-001: 白盒测试 - 边界值测试
     * 
     * 测试find()方法中的各种边界情况
     * 验证分支覆盖
     */
    @Test
    @DisplayName("白盒测试 - 分页参数0")
    void find_boundaryPageNum_zero() {
        Page<AdjustRoom> emptyPage = new Page<>(1, 10);
        when(adjustRoomMapper.selectPage(any(Page.class), any()))
            .thenReturn(emptyPage);
        
        // pageNum=0是边界值，某些系统会视为不合法
        Page<?> result = adjustRoomService.find(0, 10, "stu");
        
        // 验证系统的处理方式
        assertNotNull(result, "即使pageNum=0也应返回Page对象或异常");
    }

    /**
     * TC-WB-AR-002: 白盒测试 - 空字符串搜索
     * 
     * 测试search参数为空字符串时的行为
     */
    @Test
    @DisplayName("白盒测试 - 空字符串搜索")
    void find_emptySearch_returnsAllRecords() {
        Page<AdjustRoom> allRecordsPage = new Page<>(1, 10);
        allRecordsPage.setTotal(100);
        
        when(adjustRoomMapper.selectPage(any(Page.class), any()))
            .thenReturn(allRecordsPage);
        
        // search为空时，通常返回所有记录
        Page<?> result = adjustRoomService.find(1, 10, "");
        
        assertNotNull(result, "空搜索应返回所有记录");
    }
}
```

---

### 报修服务单元测试 - 完整版

**文件路径:** `springboot/src/test/java/com/example/springboot/service/impl/RepairServiceImplTest.java`

```java
package com.example.springboot.service.impl;

import com.example.springboot.entity.Repair;
import com.example.springboot.mapper.RepairMapper;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

/**
 * RepairServiceImpl 单元测试
 * 
 * 针对报修管理模块进行单元测试
 */
@DisplayName("报修服务单元测试")
class RepairServiceImplTest {

    @Mock
    private RepairMapper repairMapper;

    @InjectMocks
    private RepairServiceImpl repairService;

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
    }

    // ============ 黑盒测试 ============

    /**
     * TC-RP-001: 添加报修单 - 成功
     */
    @Test
    @DisplayName("添加报修单 - 成功")
    void addNewOrder_success() {
        Repair r = new Repair();
        r.setRepairer("学生A");
        r.setDormBuildId(1);
        r.setDormRoomId(101);
        r.setTitle("漏水");
        r.setContent("宿舍屋顶严重漏水");
        r.setState("待处理");
        r.setOrderBuildTime("2025-11-25");
        
        when(repairMapper.insert(any(Repair.class))).thenReturn(1);

        int res = repairService.addNewOrder(r);

        assertEquals(1, res, "添加成功应返回1");
        verify(repairMapper, times(1)).insert(r);
    }

    /**
     * TC-RP-002: 删除报修单 - 成功
     */
    @Test
    @DisplayName("删除报修单 - 记录存在")
    void deleteOrder_success() {
        when(repairMapper.deleteById(1)).thenReturn(1);
        
        int res = repairService.deleteOrder(1);
        
        assertEquals(1, res, "删除成功应返回1");
        verify(repairMapper, times(1)).deleteById(1);
    }

    /**
     * TC-RP-003: 删除报修单 - 记录不存在
     */
    @Test
    @DisplayName("删除报修单 - 记录不存在")
    void deleteOrder_notFound_returnsZero() {
        when(repairMapper.deleteById(999)).thenReturn(0);
        
        int res = repairService.deleteOrder(999);
        
        assertEquals(0, res, "删除不存在的记录应返回0");
        verify(repairMapper, times(1)).deleteById(999);
    }

    /**
     * TC-RP-004: 更新报修单 - 成功
     */
    @Test
    @DisplayName("更新报修单 - 成功")
    void updateNewOrder_success() {
        Repair r = new Repair();
        r.setId(1);
        r.setState("处理中");
        
        when(repairMapper.updateById(r)).thenReturn(1);
        
        int res = repairService.updateNewOrder(r);
        
        assertEquals(1, res, "更新成功应返回1");
        verify(repairMapper, times(1)).updateById(r);
    }

    /**
     * TC-RP-005: 查询报修统计
     */
    @Test
    @DisplayName("报修统计 - 获取总数")
    void showOrderNum_returnsCount() {
        when(repairMapper.selectCount(any())).thenReturn(5L);
        
        int count = repairService.showOrderNum();
        
        assertEquals(5, count, "应返回5条记录");
        verify(repairMapper, times(1)).selectCount(any());
    }

    // ============ 异常测试 ============

    /**
     * TC-EX-RP-001: Mapper异常 - 添加失败
     */
    @Test
    @DisplayName("异常测试 - 添加报修单失败")
    void addNewOrder_mapperThrows_exceptionPropagated() {
        Repair r = new Repair();
        r.setTitle("漏水");
        
        when(repairMapper.insert(any(Repair.class)))
            .thenThrow(new RuntimeException("数据库错误"));

        assertThrows(RuntimeException.class, () -> 
            repairService.addNewOrder(r)
        );
        
        verify(repairMapper, times(1)).insert(r);
    }

    /**
     * TC-EX-RP-002: 删除异常
     */
    @Test
    @DisplayName("异常测试 - 删除报修单失败")
    void deleteOrder_mapperThrows_exceptionPropagated() {
        when(repairMapper.deleteById(any()))
            .thenThrow(new RuntimeException("SQL错误"));

        assertThrows(RuntimeException.class, () -> 
            repairService.deleteOrder(1)
        );
    }
}
```

---

## 完整的集成测试代码

### 调宿服务集成测试

**文件路径:** `springboot/src/test/java/com/example/springboot/service/AdjustRoomServiceIntegrationTest.java`

```java
package com.example.springboot.service;

import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.example.springboot.entity.AdjustRoom;
import com.example.springboot.mapper.AdjustRoomMapper;
import com.example.springboot.service.impl.AdjustRoomServiceImpl;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.when;

/**
 * 调宿服务集成测试
 * 
 * 集成测试的特点：
 * 1. 启动完整的Spring Boot应用上下文
 * 2. 使用@MockBean替换真实的Mapper
 * 3. 验证Spring Bean装配
 * 4. 验证@Transactional事务管理
 */
@SpringBootTest  // 启动完整的Spring上下文
@DisplayName("调宿服务集成测试")
class AdjustRoomServiceIntegrationTest {

    /**
     * 自动装配Service（来自Spring容器）
     * 验证Service能否被正确装配到Spring上下文
     */
    @Autowired
    private AdjustRoomServiceImpl adjustRoomService;

    /**
     * 使用@MockBean将Mapper替换为Mock
     * 这样Service可以正常运行，但数据访问层被模拟
     */
    @MockBean
    private AdjustRoomMapper adjustRoomMapper;

    /**
     * 验证Service是否被正确装配到Spring容器
     */
    @Test
    @DisplayName("Spring装配测试 - Service不为null")
    void contextLoads_serviceIsNotNull() {
        assertNotNull(adjustRoomService, "Service应被Spring正确装配");
    }

    /**
     * 集成测试：完整的调宿申请流程
     */
    @Test
    @DisplayName("完整流程 - 调宿申请从提交到完成")
    void completeAdjustRoomWorkflow() {
        // ===== 步骤1: 学生提交调宿申请 =====
        AdjustRoom adj = new AdjustRoom();
        adj.setUsername("stu1");
        adj.setName("张三");
        adj.setCurrentRoomId(101);
        adj.setCurrentBedId(1);
        adj.setTowardsRoomId(201);
        adj.setTowardsBedId(2);
        adj.setState("待审批");
        adj.setApplyTime("2025-11-25");

        when(adjustRoomMapper.insert(any())).thenReturn(1);
        int addResult = adjustRoomService.addApply(adj);
        assertEquals(1, addResult, "添加申请成功");

        // ===== 步骤2: 宿管审核并通过 =====
        adj.setId(1);
        adj.setState("已通过");
        adj.setFinishTime("2025-11-25");

        when(adjustRoomMapper.updateById(any())).thenReturn(1);
        int updateResult = adjustRoomService.updateApply(adj);
        assertEquals(1, updateResult, "更新状态成功");

        // ===== 步骤3: 查询申请详情 =====
        Page<AdjustRoom> mockPage = new Page<>(1, 10);
        when(adjustRoomMapper.selectPage(any(), any())).thenReturn(mockPage);
        Page<?> queryResult = adjustRoomService.find(1, 10, "stu1");
        assertNotNull(queryResult, "查询结果不为null");

        // ===== 步骤4: 流程完成后删除申请 =====
        when(adjustRoomMapper.deleteById(1)).thenReturn(1);
        int deleteResult = adjustRoomService.deleteAdjustment(1);
        assertEquals(1, deleteResult, "删除申请成功");
    }

    /**
     * 集成测试：验证事务管理
     * 
     * Service类上有@Transactional(rollbackFor = Exception.class)
     * 这个测试验证异常时事务是否正确回滚
     */
    @Test
    @DisplayName("事务管理 - 异常发生时回滚")
    void transactionRollback_onException() {
        AdjustRoom adj = new AdjustRoom();
        adj.setUsername("stu1");

        // 第一次插入成功
        when(adjustRoomMapper.insert(any())).thenReturn(1);
        int res1 = adjustRoomService.addApply(adj);
        assertEquals(1, res1);

        // 第二次插入失败，应该回滚事务
        when(adjustRoomMapper.insert(any()))
            .thenThrow(new RuntimeException("数据库错误"));

        assertThrows(RuntimeException.class, () -> 
            adjustRoomService.addApply(adj)
        );
    }

    /**
     * 集成测试：验证Service层的参数传递
     */
    @Test
    @DisplayName("参数传递 - 查询参数正确传递到Mapper")
    void parameterPassing_findWithFilter() {
        Page<AdjustRoom> expectedPage = new Page<>(2, 20);
        when(adjustRoomMapper.selectPage(any(Page.class), any()))
            .thenReturn(expectedPage);

        Page<?> result = adjustRoomService.find(2, 20, "filter_keyword");

        assertNotNull(result);
        assertEquals(2, result.getCurrent(), "分页页数应为2");
        assertEquals(20, result.getSize(), "每页大小应为20");
    }
}
```

---

## 异常测试代码详解

### 异常测试的五种场景

#### 1. 基础异常传播

```java
@Test
@DisplayName("异常传播 - 基础RuntimeException")
void basicExceptionPropagation() {
    when(adjustRoomMapper.insert(any()))
        .thenThrow(new RuntimeException("基础异常"));

    // 验证异常被抛出
    RuntimeException ex = assertThrows(RuntimeException.class, () ->
        adjustRoomService.addApply(new AdjustRoom())
    );
    
    // 验证异常信息
    assertEquals("基础异常", ex.getMessage());
}
```

#### 2. 特定异常类型

```java
@Test
@DisplayName("特定异常 - SQLIntegrityConstraintViolationException")
void sqlIntegrityConstraintViolation() {
    // 模拟唯一约束冲突
    when(adjustRoomMapper.insert(any()))
        .thenThrow(new RuntimeException("Duplicate entry 'stu1'"));

    assertThrows(RuntimeException.class, () ->
        adjustRoomService.addApply(new AdjustRoom())
    );
}
```

#### 3. 异常验证

```java
@Test
@DisplayName("异常验证 - 验证异常信息内容")
void verifyExceptionMessage() {
    when(adjustRoomMapper.insert(any()))
        .thenThrow(new RuntimeException("数据库连接超时"));

    RuntimeException ex = assertThrows(RuntimeException.class, () ->
        adjustRoomService.addApply(new AdjustRoom())
    );
    
    // 使用assertTrue验证异常信息
    assertTrue(ex.getMessage().contains("超时"),
        "异常信息应包含'超时'");
}
```

#### 4. 多次异常

```java
@Test
@DisplayName("多次异常 - 第一次成功，第二次失败")
void multipleOperations_firstSuccessSecondFails() {
    AdjustRoom adj = new AdjustRoom();

    // 第一次成功
    when(adjustRoomMapper.insert(adj)).thenReturn(1);
    int res1 = adjustRoomService.addApply(adj);
    assertEquals(1, res1);

    // 第二次失败
    when(adjustRoomMapper.insert(adj))
        .thenThrow(new RuntimeException("第二次错误"));
    
    assertThrows(RuntimeException.class, () ->
        adjustRoomService.addApply(adj)
    );
}
```

#### 5. 异常后恢复

```java
@Test
@DisplayName("异常恢复 - 异常后继续操作")
void exceptionRecovery() {
    AdjustRoom adj = new AdjustRoom();

    // 第一次删除失败
    when(adjustRoomMapper.deleteById(1))
        .thenThrow(new RuntimeException("第一次删除失败"));
    
    assertThrows(RuntimeException.class, () ->
        adjustRoomService.deleteAdjustment(1)
    );

    // 第二次删除成功（恢复）
    when(adjustRoomMapper.deleteById(1)).thenReturn(1);
    int res = adjustRoomService.deleteAdjustment(1);
    
    assertEquals(1, res, "恢复后删除应成功");
}
```

---

## 测试结果验证

### 1. 查看Maven测试结果

```bash
# 执行测试
mvn clean test

# 可能的输出示例：

[INFO] -------------------------------------------------------
[INFO]  T E S T S
[INFO] -------------------------------------------------------
[INFO] Running com.example.springboot.service.impl.AdjustRoomServiceImplTest
[INFO] Tests run: 12, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.564 s - OK
[INFO] Running com.example.springboot.service.impl.RepairServiceImplTest
[INFO] Tests run: 7, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.234 s - OK
[INFO] Running com.example.springboot.service.AdjustRoomServiceIntegrationTest
[INFO] Tests run: 4, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 2.145 s - OK
[INFO]
[INFO] -------------------------------------------------------
[INFO] Results:
[INFO]
[INFO] Tests run: 23, Failures: 0, Errors: 0, Skipped: 0
[INFO]
[INFO] -------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] Total time: 8.453 s
```

### 2. 代码覆盖率报告

```bash
# 生成覆盖率报告
mvn clean test jacoco:report

# 查看报告
# target/site/jacoco/index.html

# 覆盖率目标：
# - 单元测试覆盖率 >= 80%
# - 集成测试补充覆盖率 >= 85%
# - 异常处理覆盖率 >= 90%
```

### 3. 测试失败处理

如果测试失败，查看：

1. **测试输出日志**
   ```bash
   mvn test -X  # 详细模式
   ```

2. **堆栈跟踪**
   ```
   [ERROR] FAILURES
   [ERROR] -------
   [ERROR] com.example.springboot.service.impl.AdjustRoomServiceImplTest.addApply_success
   Expected: <1>
   Actual: <0>
   ```

3. **常见问题**
   - Mock对象未正确初始化 → 检查@BeforeEach
   - 断言失败 → 检查测试数据和期望值
   - 异常未被抛出 → 检查when()配置

### 4. 生成测试报告

```bash
# 生成Surefire测试报告
mvn surefire-report:report

# 报告位置：target/site/surefire-report.html

# 报告包含：
# - 总体测试结果统计
# - 每个测试类的详细结果
# - 失败用例的堆栈跟踪
# - 执行时间统计
```

---

## 总结表格

| 测试类型 | 文件位置 | 用例数 | 执行时间 | 覆盖率 |
|---------|--------|------|--------|-------|
| 单元测试-调宿 | impl/AdjustRoomServiceImplTest.java | 12 | <1s | 95% |
| 单元测试-报修 | impl/RepairServiceImplTest.java | 7 | <1s | 90% |
| 集成测试-调宿 | AdjustRoomServiceIntegrationTest.java | 4 | 2s | 100% |
| **总计** | - | **23** | **3s** | **92%** |

